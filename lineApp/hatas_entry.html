<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>スプレッドシートテスト</title>
  </head>
  <body>
    <h2>スプレッドシートテスト</h2>
    <div id="userInfo" style="display: none;">
      <p>ユーザーID: <span id="displayUserId"></span></p>
      <p>ユーザー名: <span id="displayUserName"></span></p>
    </div>
    <button id="btnRecord">テスト記録</button>
    <p id="status"></p>

    <script src="https://static.line-scdn.net/liff/2.2.0/sdk.js"></script>
    <script>
      // LIFF IDとGASのURLを各自のものに置き換えてください
      const LIFF_ID = '2007867087-B6Vy7nGv';
      const GAS_URL = 'https://script.google.com/macros/s/AKfycbwz.../exec'; // GASのウェブアプリURLに置き換え

      let userId = '';
      let userName = '';
      const btn = document.getElementById('btnRecord');
      const statusElem = document.getElementById('status');
      const userInfoDiv = document.getElementById('userInfo');
      const displayUserId = document.getElementById('displayUserId');
      const displayUserName = document.getElementById('displayUserName');

      async function initializeLiff() {
        try {
          await liff.init({ liffId: LIFF_ID });
          if (liff.isLoggedIn()) {
            const profile = await liff.getProfile();
            userId = profile.userId;
            userName = profile.displayName;
            
            displayUserId.textContent = userId;
            displayUserName.textContent = userName;
            userInfoDiv.style.display = 'block';
            
          } else {
            liff.login();
          }
        } catch (err) {
          console.error(err);
          statusElem.textContent = 'LIFFの初期化に失敗しました。';
        }
      }

      btn.onclick = async () => {
        if (!userId) {
          statusElem.textContent = 'ユーザー情報を取得できませんでした。LIFFアプリを再起動してください。';
          return;
        }
        btn.disabled = true;
        statusElem.textContent = '通信中...';

        try {
          const response = await fetch(GAS_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ userId, userName }),
          });

          if (!response.ok) {
            throw new Error('GASからの応答が正常ではありません。');
          }

          const result = await response.json();
          if (result.result === 'success') {
            statusElem.textContent = 'テスト記録が完了しました！';
          } else {
            statusElem.textContent = 'GASからの応答にエラーがあります。';
          }

        } catch (error) {
          statusElem.textContent = '通信エラーが発生しました。詳細はコンソールを確認してください。';
          console.error(error);
        } finally {
          btn.disabled = false;
        }
      };

      initializeLiff();
    </script>
  </body>
</html>